{% extends "spareapp/contBase.html" %}

{% block title %} To Collect {% endblock %}

{% block content %}

{% load static %}

{% include "spareapp/contSuperior.html" %}

<div class="container">
<div class="col-lg-5">
    <input type="text" class="form-control" name="cod" id="cod" aria-describedby="codHelp" placeholder="Filter... ">
</div>
</div>

<div class="container mt-2">
<table class="table-bordered invoice">
    <thead id="hSup">
        <tr class="excludeFooter" style="background-color: #F5F087">
            <th class="p-2">
                <span style="font-weight: bold;">Por cobrar</span>
            </th>
        </tr>
    </thead>
</table>
</div>

<div class="container mb-2">
    <table id="invoice" style="font-size: small;" class="table-bordered invoice draggable table-sortable">
        <thead>
            <tr style="background-color: #7C8FEC;position: sticky;top: 70;" class="">
                <th class="p-2"># Factura</th>
                <th class="p-2">Nombre</th>
                <th class="p-2">Categoría</th>
                <th class="p-2">Nota</th>
                <th class="p-2">Fecha de registro</th>
                <th class="p-2">Límite</th>
                <th id="facMonto" class="p-2">Monto</th>
                <th class="p-2">ITBM</th>
                <th id="facTotal" class="p-2">Total</th>
                <th class="p-2 exclude">Acción</th>
            </tr>
        </thead>

        <tbody id="myTable">
            {% for facture in allFacturesPay %}
            <tr>
                <td class="p-2">{{facture.num}}</td>
                <td class="p-2"><a href="{% url 'contIndividual' facture.refPersona.id %}">{{facture.refPersona}}</a></td>
                <td class="p-2">{{facture.refCategory}}</td>
                <td class="p-2">{{facture.note}}</td>
                <td class="p-2">{{facture.fechaCreado|date:"M d, Y"}}</td>
                {% for key,value in deadlineDic.items %}
                    {% if key == facture.id %}
                        <td style="max-width: 120px;" class="p-2">{{value}} days</td>
                    {% endif %}
                {% endfor %}
                <td class="p-2">${{facture.monto|floatformat:2}}</td>
                <td class="p-2">{{facture.iva|floatformat:2}}</td>
                <td class="p-2">${{facture.total|floatformat:2}}</td>
                <td class="p-2 exclude"><a data-bs-toggle="modal" type="button" data-bs-target="#modalCobrar{{facture.id}}" style="font-size: small;color: aliceblue;" id="modalCobrar{{facture.id}}Id" class="btn btn-danger" href="javascript:void(0);">Cobrar</a></td>

                <div tabindex="-1" id="modalCobrar{{facture.id}}" class="modal fade modal-dialog-scrollable" aria-labelledby="modalCobrar{{facture.id}}Label" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalCobrar{{facture.id}}Label">Cobrar factura</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body"> 
                                <form id="formCust" method="POST" action="{% url 'contCollectFac' facture.id %}">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <div>¿Seguro que desea cobrar la factura número {{facture.num}}?</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" for="contNota">Nota</label>
                                        <textarea class="form-control" id="contNota" type="textarea" name="contNota"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Cobrar</button>
                                </form>
                                
                            </div>   
                        </div>
                    </div>
                </div> 

            </tr>
            
            {% endfor %}
            
            <tr class="tfoot" style="background-color: #E77C7C;">
                <td class="p-2">Total</td>
                <td class="p-2"></td>
                <td class="p-2"></td>
                <td class="p-2"></td>
                <td class="p-2"></td>
                <td class="p-2"></td>
                <td class="p-2">${{montoTotal|floatformat:2}}</td>
                <td class="p-2"></td>
                <td class="p-2">${{totalTotal|floatformat:2}}</td>
                <td class="p-2 exclude"></td>
            </tr>
            
        </tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/pdfmake.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/pdfmake.js.map"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/pdfmake.min.js.map"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/vfs_fonts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/fonts/Roboto/Roboto-Medium.ttf"></script>

<script type="text/javascript" src="{% static 'spareapp/html2canvas.min.js' %}"></script>

<script type="text/javascript" src="{% static 'spareapp/dragtable.js' %}"></script>

<script>

    $("#cod").on("keyup",function(){                                // Cuando se teclea algo
        var value = $(this).val().toLowerCase();                        // Toma el valor del input en minuscula
        var sumarMonto = 0
        var auxMonto = 0
        var totalMonto = 0
        var sumarTotal = 0
        var auxTotal = 0
        var totalTotal = 0

        $(".invoice tbody tr").filter(function(){                             // 
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        })

        $(".tfoot").hide()

        $("#invoice tbody tr").each(function(){
            $(this).find("td").each(function(){
                if ($(this).index() == $("#facTotal").index()) {
                    if ($(this).is(":visible")){
                        sumarTotal = $(this).text()
                        auxTotal = sumarTotal.split("$")[1]
                    }
                    else{
                        auxTotal = 0
                    }
                    
                }
                if ($(this).index() == $("#facMonto").index()) {
                    if ($(this).is(":visible")){
                        sumarMonto = $(this).text()
                        auxMonto = sumarMonto.split("$")[1]
                    }
                    else{
                        auxMonto = 0
                    }
                    
                }
            })
            
            totalMonto = totalMonto + parseFloat(auxMonto)
            totalTotal = totalTotal + parseFloat(auxTotal)
        })

        $(".erase").remove()
        $("#myTable").append("<tr class='tfoot erase' style='background-color: #E77C7C;'><td class='p-2'>Total</td><td class='p-2'></td><td class='p-2'></td><td class='p-2'></td><td class='p-2'></td><td class='p-2'></td><td class='p-2'>$"+totalMonto.toFixed(2)+"</td><td class='p-2'></td><td class='p-2'>$"+totalTotal.toFixed(2)+"</td><td class='p-2 exclude'></td></tr>")

        if(value==""){
            $(".erase").remove()
            $(".tfoot").show()
        }
    })
</script>

<script>

function generatePDF2(){

if($("#cod").val()){
    var tableFooterCells = [...document.querySelectorAll('.erase td:not(.exclude)')].map(thElement => ({ text: thElement.textContent, style: 'tableFooter' }));
}else{
    var tableFooterCells = [...document.querySelectorAll('.tfoot td:not(.exclude)')].map(thElement => ({ text: thElement.textContent, style: 'tableFooter' }));
}

var tableHeaderTextSup = [...document.querySelectorAll('.excludeFooter th')].map(thElement => ({ text: thElement.textContent, style: 'tableHeaderSup' }));
var tableHeaderText = [...document.querySelectorAll('#invoice thead tr th:not(.exclude)')].map(thElement => ({ text: thElement.textContent, style: 'tableHeader' }));
var tableRowCells = [...document.querySelectorAll('#invoice tbody tr:not(.tfoot) td:not(.exclude)')].map(tdElement => ({ text: tdElement.textContent, style: 'tableData' }));
// var tableFooterCells = [...document.querySelectorAll('.tfoot td:not(.exclude)')].map(thElement => ({ text: thElement.textContent, style: 'tableFooter' }));
// var tableFooterCells = [...document.querySelectorAll('#invoice tfoot tr th:not(.exclude)')].map(thElement => ({ text: thElement.textContent, style: 'tableFooter' }));
// alert(tableFooterCells)

var rows = []
var fila = []
var footerFooter = []
var footerAux = []
var cont = 0

$("#myTable tr:not(.tfoot").each(function(){
    if ($(this).is(":visible")){
        $(this).find("td:not(.exclude)").each(function(){
            fila.push($(this).text())
            cont = cont + 1
        })
        if ((cont==tableHeaderText.length)){
            rows.push(fila)
            fila = []
            cont = 0
        }
    }
})

var aux = ""

footerFooter.push(tableFooterCells)

var docDefinition = {
    info: {
	title: 'Facturas por cobrar',
    },
  content: [
    {
      layout: 'lightHorizontalLines', // optional
      style: 'tableExample',
      table: {
        headerRows: 2,
        body: [
        [{text: tableHeaderTextSup[0].text, colSpan: 9},"","","","","","","",""],
        tableHeaderText,
        ...rows,
        ...footerFooter,
        // [aux,"","","","","","",""],
        ],
        // extend: 'pdf',
        // title: 'Customized PDF Title',
        // filename: 'customized_pdf_file_name'
      },
      layout: {

        fillColor: function(rowIndex) {
            if (rowIndex === 0) {
              return '#F5F087';
            }
            if (rowIndex === 1) {
              return '#7C8FEC';
            }
            if (rowIndex === (rows.length + 2)) {
                return '#E77C7C';
            }
            return (rowIndex % 2 === 0) ? '#f2f2f2' : null;
          }
        },
    },
  ],
    styles: {
        tableExample: {
            // margin: [0, 20, 0, 80],
            margin: [0, 1, 0, 1],
            fontSize: 8,
        },
        tableHeaderSup: {
            margin: 1,
            color: 'black',
            fontSize: 8,
        },
        tableHeader: {
            margin: 1,
            color: 'black',
            fontSize: 8,
        },
        tableData: {
            margin: 1,
            // fontSize: 10,
        },
        fuente: {
            margin: 1,
            fontSize: 8,
        },
        tableFooter: {
            margin: 1,
            fontSize: 8,
        },
    },
};

// pdfMake.createPdf(docDefinition).download();
pdfMake.createPdf(docDefinition).download("FacturasCobrar");

}

$("#invoice").dragtable()

</script>

{% endblock %}